<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markt-Dashboard | EV Technical Insights</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        /* Styles identisch gelassen */
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--navy:#002B5B;--navy-dark:#001a38;--cyan:#00F2FF;--surface:#F9FAFB;--stone:#E5E7EB;--anthracite:#1F2937;--text-secondary:#6B7280;--success:#10B981;--danger:#EF4444;--font-headline:'Inter',sans-serif;--font-mono:'JetBrains Mono',monospace}
        body{font-family:var(--font-headline);background:var(--surface);color:var(--anthracite)}
        .container{max-width:1280px;margin:0 auto;padding:0 24px}
        
        .header{background:var(--navy);color:white;position:sticky;top:0;z-index:1000}
        .header-main{display:flex;justify-content:space-between;align-items:center;padding:16px 0}
        .nav-links{display:flex;list-style:none;gap:8px}
        .nav-links a{color:rgba(255,255,255,0.85);text-decoration:none;font-size:14px;font-weight:500;padding:10px 16px;border-radius:6px}
        .nav-links a.active{background:var(--cyan);color:var(--navy)}
        .mobile-menu-btn{display:none;background:none;border:none;color:white;font-size:28px}
        
        .page-header{background:linear-gradient(135deg,var(--navy),var(--navy-dark));color:white;padding:48px 0}
        .data-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(0,242,255,0.15);border:1px solid var(--cyan);padding:6px 12px;border-radius:20px;font-family:var(--font-mono);font-size:11px;color:var(--cyan);margin-top:16px}
        
        .kpi-section{padding:32px 0;background:white;border-bottom:1px solid var(--stone)}
        .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
        .kpi-card{background:var(--surface);border-radius:12px;padding:24px;border:1px solid var(--stone)}
        .kpi-value{font-family:var(--font-mono);font-size:32px;font-weight:800;color:var(--navy)}
        .kpi-change{font-family:var(--font-mono);font-size:12px;margin-top:8px;padding:4px 8px;border-radius:4px;display:inline-block}
        .kpi-change.positive{background:rgba(16,185,129,0.1);color:var(--success)}
        .kpi-change.negative{background:rgba(239,68,68,0.1);color:var(--danger)}
        
        .charts-section{padding:40px 0}
        .charts-grid{display:grid;grid-template-columns:2fr 1fr;gap:24px}
        .chart-card{background:white;border-radius:12px;border:1px solid var(--stone);overflow:hidden;height:400px;padding:20px}
        
        .tables-section{padding:0 0 60px}
        .tables-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
        .table-card{background:white;border-radius:12px;border:1px solid var(--stone);padding:20px}
        table{width:100%;border-collapse:collapse;margin-top:10px}
        th,td{padding:12px;text-align:left;border-bottom:1px solid var(--stone)}
        .trend-up{color:var(--success)} .trend-down{color:var(--danger)}

        .footer{background:var(--navy-dark);color:white;padding:40px 0}

        @media(max-width:1024px){.nav-links{display:none}.mobile-menu-btn{display:block}.kpi-grid{grid-template-columns:1fr 1fr}.charts-grid,.tables-grid{grid-template-columns:1fr}}
        @media(max-width:768px){.kpi-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>

    <header class="header"><div class="container"><div class="header-main">
        <a href="index.html" style="text-decoration:none;font-weight:800;font-size:20px;color:white">‚ö° EV <span style="color:var(--cyan)">Insights</span></a>
        <ul class="nav-links">
            <li><a href="dashboard.html" class="active">üìä Dashboard</a></li>
            <li><a href="fahrzeuge.html">üîã Fahrzeuge</a></li>
            <li><a href="news.html">üì∞ News</a></li>
            <li><a href="laden.html">‚ö° Laden</a></li>
            <li><a href="ratgeber.html">üìã Ratgeber</a></li>
            <li><a href="reichweite.html">üìè Analyse</a></li>
        </ul>
        <button class="mobile-menu-btn">‚ò∞</button>
    </div></div></header>

    <section class="page-header"><div class="container">
        <h1 style="font-size:32px; margin-bottom:10px;">üìä Markt-Dashboard</h1>
        <p>Live-Daten & Statistiken Schweiz</p>
        <div class="data-badge" id="update-badge">Lade Daten...</div>
    </div></section>

    <section class="kpi-section"><div class="container">
        <div class="kpi-grid">
            <div class="kpi-card">
                <div style="font-size:12px;color:#666;text-transform:uppercase;">BEV-Marktanteil</div>
                <div class="kpi-value" id="kpi-share">--</div>
                <div class="kpi-change" id="kpi-share-change">--</div>
            </div>
            <div class="kpi-card">
                <div style="font-size:12px;color:#666;text-transform:uppercase;">BEV Neuzulassungen</div>
                <div class="kpi-value" id="kpi-sales">--</div>
                <div class="kpi-change" id="kpi-sales-change">--</div>
            </div>
            <div class="kpi-card">
                <div style="font-size:12px;color:#666;text-transform:uppercase;">Markt Total</div>
                <div class="kpi-value" id="kpi-total">--</div>
                <div class="kpi-change" id="kpi-total-change">--</div>
            </div>
            <div class="kpi-card">
                <div style="font-size:12px;color:#666;text-transform:uppercase;">Elektrifiziert (BEV+PHEV)</div>
                <div class="kpi-value" id="kpi-elec">--</div>
                <div class="kpi-change" id="kpi-elec-change">--</div>
            </div>
        </div>
    </div></section>

    <section class="charts-section"><div class="container">
        <div class="charts-grid">
            <div class="chart-card">
                <h3>üìà Trend 2024</h3>
                <div style="height:320px"><canvas id="chart-main"></canvas></div>
            </div>
            <div class="chart-card">
                <h3>ü•ß Antriebsarten</h3>
                <div style="height:320px"><canvas id="chart-pie"></canvas></div>
            </div>
        </div>
    </div></section>

    <section class="tables-section"><div class="container">
        <div class="tables-grid">
            <div class="table-card">
                <h3>üèÜ Top Marken</h3>
                <table id="table-brands"><thead><tr><th>#</th><th>Marke</th><th>Verk√§ufe</th><th>Trend</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="table-card">
                <h3>üöó Top Modelle</h3>
                <table id="table-models"><thead><tr><th>#</th><th>Modell</th><th>Verk√§ufe</th><th>Anteil</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div></section>

    <footer class="footer"><div class="container" style="text-align:center; font-size:12px; color:rgba(255,255,255,0.5)">
        ¬© 2025 EV Technical Insights | <a href="impressum.html" style="color:white">Impressum</a>
    </div></footer>

    <script>
        // --- HIER WAR DER FEHLER: JETZT MIT DER KORREKTEN URL ---
        // Wir nutzen den Pfad mit /refs/heads/, den du gefunden hast:
        const DATA_BASE = 'https://raw.githubusercontent.com/emirdurut-maker/ev-portal-schweiz/refs/heads/main/data/';
        
        async function init() {
            try {
                // Lade alle CSVs parallel
                const [markt, marken, modelle] = await Promise.all([
                    loadCSV(DATA_BASE + 'markt.csv'),
                    loadCSV(DATA_BASE + 'marken.csv'),
                    loadCSV(DATA_BASE + 'modelle.csv')
                ]);

                // Update Datum-Badge
                const last = markt[markt.length - 1];
                document.getElementById('update-badge').textContent = `Stand: ${last.monat} ${last.jahr}`;

                // Update KPIs & Charts
                updateKPIs(markt);
                renderCharts(markt);
                
                // Tabellen f√ºllen
                renderTable('table-brands', marken, ['rang', 'marke', 'verkaeufe', 'trend']);
                
                // Modelle MIT BILDERN
                const tbody = document.querySelector('#table-models tbody');
                tbody.innerHTML = modelle.slice(0, 5).map(row => {
                    // Bild-Name generieren (Tesla Model Y -> tesla-model-y.jpg)
                    const imgName = (row.marke + " " + row.modell).toLowerCase()
                        .replace(/√§/g, 'ae').replace(/√∂/g, 'oe').replace(/√º/g, 'ue')
                        .replace(/[^a-z0-9 ]/g, '').trim().replace(/\s+/g, '-') + '.jpg';
                    
                    return `
                    <tr>
                        <td style="font-weight:bold; color:#00F2FF">#${row.rang}</td>
                        <td style="display:flex; align-items:center; gap:10px;">
                            <img src="./images/${imgName}" onerror="this.style.display='none'" 
                                 style="width:40px; height:24px; object-fit:cover; border-radius:4px; background:#eee;">
                            <strong>${row.marke} ${row.modell}</strong>
                        </td>
                        <td>${row.verkaeufe}</td>
                        <td>${row.anteil}%</td>
                    </tr>`;
                }).join('');

            } catch (e) {
                console.error(e);
                document.getElementById('update-badge').textContent = "‚ö†Ô∏è Fehler: Daten-URL falsch";
            }
        }

        // Helfer-Funktionen
        function loadCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true, header: true, dynamicTyping: true, skipEmptyLines: true,
                    complete: r => resolve(r.data),
                    error: e => reject(e)
                });
            });
        }

        function updateKPIs(data) {
            const cur = data[data.length-1];
            const prev = data[data.length-2] || cur;
            
            setKPI('kpi-share', cur.bev_anteil + '%', (cur.bev_anteil - prev.bev_anteil).toFixed(1));
            setKPI('kpi-sales', cur.bev, ((cur.bev - prev.bev)/prev.bev * 100).toFixed(0));
            setKPI('kpi-total', cur.total, ((cur.total - prev.total)/prev.total * 100).toFixed(0));
            
            const elec = (cur.bev_anteil + cur.phev_anteil).toFixed(1);
            setKPI('kpi-elec', elec + '%', (elec - (prev.bev_anteil + prev.phev_anteil)).toFixed(1));
        }

        function setKPI(id, val, change) {
            document.getElementById(id).textContent = val;
            const el = document.getElementById(id + '-change');
            el.textContent = (change >= 0 ? '+' : '') + change + '%';
            el.className = `kpi-change ${change >= 0 ? 'positive' : 'negative'}`;
        }

        function renderCharts(data) {
            new Chart(document.getElementById('chart-main'), {
                type: 'bar',
                data: {
                    labels: data.map(d => d.monat),
                    datasets: [{label:'BEV', data:data.map(d=>d.bev), backgroundColor:'#00F2FF'}, {label:'Rest', data:data.map(d=>d.total-d.bev), backgroundColor:'#002B5B'}]
                },
                options: {responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true},y:{stacked:true}}}
            });
            
            const last = data[data.length-1];
            new Chart(document.getElementById('chart-pie'), {
                type: 'doughnut',
                data: {
                    labels: ['BEV', 'PHEV', 'Hybrid', 'Verbrenner'],
                    datasets: [{data:[last.bev_anteil, last.phev_anteil, last.hev_anteil, last.ice_anteil], backgroundColor:['#00F2FF','#002B5B','#6B7280','#E5E7EB']}]
                },
                options: {responsive:true, maintainAspectRatio:false}
            });
        }

        function renderTable(id, data, cols) {
            document.querySelector(`#${id} tbody`).innerHTML = data.slice(0,5).map(r => 
                `<tr><td>#${r[cols[0]]}</td><td><strong>${r[cols[1]]}</strong></td><td>${r[cols[2]]}</td><td class="${r[cols[3]]>=0?'trend-up':'trend-down'}">${r[cols[3]]}%</td></tr>`
            ).join('');
        }

        // Mobile Menu Button
        document.querySelector('.mobile-menu-btn').addEventListener('click', () => {
             document.getElementById('mobile-menu').classList.add('active');
        });
        document.querySelector('.mobile-menu-close').addEventListener('click', () => {
             document.getElementById('mobile-menu').classList.remove('active');
        });

        init();
    </script>
</body>
</html>
